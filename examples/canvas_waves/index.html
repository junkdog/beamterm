<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸŒŠ</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        background-color: #121212;
        overflow: hidden;
      }

      nav {
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 10px;
        flex-shrink: 0;
      }

      nav a {
        color: aqua;
        text-decoration: none;
        font-family: "Fira Code", monospace;
        font-size: 16px;
        padding: 5px 10px;
        border: 1px solid aqua;
        border-radius: 4px;
      }

      nav a:hover, nav a.active {
        background-color: aqua;
        color: #121212;
      }

      #terminal-size {
        color: #888;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        padding: 5px 10px;
      }

      .perf-metric {
        position: relative;
        color: #888;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        padding: 5px 10px;
        cursor: help;
      }

      .perf-metric .label {
        color: #6a9;
      }

      .perf-metric .value {
        color: #aaa;
        min-width: 60px;
        display: inline-block;
        text-align: right;
      }

      .perf-metric .tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2a2a2a;
        color: #ccc;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        transition: opacity 0.2s;
        border: 1px solid #444;
        margin-top: 5px;
      }

      .perf-metric .tooltip::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-bottom-color: #444;
      }

      .perf-metric:hover .tooltip {
        visibility: visible;
        opacity: 1;
      }

      pre {
        font-family: "Fira Code", monospace;
        font-size: 16px;
        margin: 0px;
      }

      #container {
        flex: 1;
        min-height: 0; /* Allow flex item to shrink below content size */
        width: 100%;
        position: relative;
        overflow: hidden;
      }

      #container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: block;
      }
    </style>

    <link
        rel="rust"
        href="Cargo.toml"
        data-trunk
        data-wasm-opt = "4"/>

  </head>
  <body>
    <nav>
      <a href="?atlas_size=10">Hack 10pt</a>
      <a href="?atlas_size=15">Hack 15pt</a>
      <span id="terminal-size"></span>
      <span class="perf-metric" id="perf-sync">
        <span class="label">sync:</span>
        <span class="value">--</span>
        <span class="tooltip">Ratatui's cell data synchronization with beamterm</span>
      </span>
      <span class="perf-metric" id="perf-render">
        <span class="label">render:</span>
        <span class="value">--</span>
        <span class="tooltip">Flushes the GPU buffers and executes the WebGL draw call</span>
      </span>
    </nav>
    <div id="container"></div>
    <script>
      // Highlight active link based on query param
      const params = new URLSearchParams(window.location.search);
      const size = params.get('atlas_size') || '15';
      document.querySelectorAll('nav a').forEach(a => {
        if (a.href.includes(`atlas_size=${size}`)) {
          a.classList.add('active');
        }
      });

      // Update terminal size display
      function updateTerminalSize() {
        if (window.__beamterm_debug) {
          const size = window.__beamterm_debug.getTerminalSize();
          const cells = size.cols * size.rows;
          document.getElementById('terminal-size').textContent =
            `${size.cols}x${size.rows} (${cells.toLocaleString()} cells)`;
        }
      }

      // Trigger resize after layout settles
      new ResizeObserver(() => {
        window.dispatchEvent(new Event('resize'));
        setTimeout(updateTerminalSize, 100);
      }).observe(document.getElementById('container'));

      // Display terminal size after initialization
      setTimeout(updateTerminalSize, 500);

      // Performance metrics display - uses rolling window average
      const perfState = {
        sync: { lastIndex: 0 },
        render: { lastIndex: 0 }
      };

      function getMetricStats(name, state) {
        const entries = performance.getEntriesByName(name);
        if (entries.length === 0) return null;

        // Only process new entries since last check
        const newEntries = entries.slice(state.lastIndex);
        state.lastIndex = entries.length;

        if (newEntries.length === 0) return null;

        const sum = newEntries.reduce((acc, e) => acc + e.duration, 0);
        return { avg: sum / newEntries.length, count: newEntries.length };
      }

      function formatDuration(ms) {
        if (ms === null) return '--';
        if (ms < 0.001) return '< 1Âµs';
        if (ms < 1) return `${(ms * 1000).toFixed(0)}Âµs`;
        return `${ms.toFixed(2)}ms`;
      }

      function updatePerfMetrics() {
        const syncStats = getMetricStats('sync-terminal-buffer', perfState.sync);
        const renderStats = getMetricStats('webgl-render', perfState.render);

        const syncEl = document.querySelector('#perf-sync .value');
        const renderEl = document.querySelector('#perf-render .value');

        syncEl.textContent = syncStats ? formatDuration(syncStats.avg) : syncEl.textContent;
        renderEl.textContent = renderStats ? formatDuration(renderStats.avg) : renderEl.textContent;
      }

      // Update performance metrics every 3 seconds
      setInterval(updatePerfMetrics, 3000);
    </script>
  </body>
</html>
